<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Speech Enhancer</title>
  <style>
    body { font-family: sans-serif; background: black; color: white; padding: 20px; }
    button, select, input { margin: 10px 0; padding: 10px; }
    #transcriptBox { white-space: pre-wrap; border: 1px solid white; padding: 10px; margin: 10px 0; min-height: 60px; background: #111; }
  </style>
</head>
<body>
  <h1>Speech Enhancer</h1>

  <label for="modelSelect">Choose STT Model:</label><br>
  <select id="modelSelect">
    <option value="whisper">Whisper</option>
    <option value="vosk">Vosk</option>
  </select><br><br>

  <button id="recordBtn">ğŸ™ï¸ Start Recording</button>
  <button id="stopBtn" disabled>â¹ï¸ Stop Recording</button><br><br>

  <input type="file" id="audioFile" accept="audio/*">
  <button id="uploadBtn">Upload & Convert</button><br><br>

  <h3>Transcription:</h3>
  <div id="transcriptBox"></div><br>

  <button id="ttsBtn" disabled>ğŸ”Š Synthesize with Piper</button><br>
  <audio id="audioPlayer" controls style="display:none;"></audio>
  <a id="downloadLink" style="display:none;" download="piper_output.wav">â¬‡ï¸ Download Audio</a>

  <script>
    let mediaRecorder, audioChunks = [];

    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const audioFile = document.getElementById('audioFile');
    const transcriptBox = document.getElementById('transcriptBox');
    const ttsBtn = document.getElementById('ttsBtn');
    const modelSelect = document.getElementById('modelSelect');
    const audioPlayer = document.getElementById('audioPlayer');
    const downloadLink = document.getElementById('downloadLink');

    const BACKEND_URL = "https://evaluating-fully-retrieve-commonwealth.trycloudflare.com";

    recordBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/wav' });
        sendAudio(blob);
      };

      mediaRecorder.start();
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    uploadBtn.onclick = () => {
      const file = audioFile.files[0];
      if (file) sendAudio(file);
    };

    function sendAudio(blob) {
      const formData = new FormData();
      formData.append('audio', blob);
      formData.append('model', modelSelect.value);

      transcriptBox.textContent = 'Processing...';
      ttsBtn.disabled = true;
      audioPlayer.style.display = 'none';
      downloadLink.style.display = 'none';

      fetch(`${BACKEND_URL}/transcribe`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
          transcriptBox.textContent = data.text || 'No transcription';
          ttsBtn.disabled = false;
        })
        .catch(err => {
          transcriptBox.textContent = 'Error: ' + err.message;
        });
    }

    ttsBtn.onclick = () => {
      const formData = new FormData();
      formData.append('text', transcriptBox.textContent);

      fetch(`${BACKEND_URL}/synthesize`, { method: 'POST', body: formData })
        .then(res => res.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          audioPlayer.src = url;
          audioPlayer.style.display = 'block';
          downloadLink.href = url;
          downloadLink.style.display = 'inline';
        })
        .catch(err => {
          alert('Synthesis failed: ' + err.message);
        });
    };
  </script>
</body>
</html>
